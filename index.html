<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Food Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f9fafb; color: #1f2937; }
    .container { max-width: 960px; margin: auto; padding: 30px 20px; }
    h1 { text-align: center; font-size: 2.2em; margin-bottom: 10px; }
    section { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-top: 30px; }
    input, textarea, button { width: 100%; padding: 14px; margin-top: 12px; font-size: 1em; border: 1px solid #d1d5db; border-radius: 10px; transition: 0.2s; }
    input:focus, textarea:focus, button:focus { outline: none; border-color: #6366f1; }
    button { background: #6366f1; color: white; border: none; cursor: pointer; font-weight: 600; }
    button:hover { background: #4f46e5; }
    .loading { color: #059669; font-weight: bold; margin-top: 10px; }
    pre { white-space: pre-wrap; background: #f3f4f6; padding: 15px; border-radius: 10px; margin-top: 15px; }
    img { max-width: 100%; border-radius: 12px; margin-top: 15px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü•ó Smart Food Analyzer</h1>

    <section>
      <h2>üì∏ Upload a Food Label Image</h2>
      <input type="file" accept="image/*" id="imageInput">
      <button onclick="processImage()">Extract & Analyze</button>
      <div id="loading1" class="loading"></div>
      <img id="preview" style="display:none">
      <pre id="ocrText"></pre>
      <pre id="nutritionText"></pre>
      <pre id="aiExplanation"></pre>
    </section>

    <section>
      <h2>‚úçÔ∏è Or Describe What You Ate</h2>
      <textarea id="userText" placeholder="E.g., 1 boiled egg, 1 toast, 1 cup coffee"></textarea>
      <button onclick="analyzeUserFood()">Analyze</button>
      <div id="loading2" class="loading"></div>
      <pre id="userNutrition"></pre>
      <pre id="userAiExplanation"></pre>
    </section>
  </div>

  <script>
    const APP_ID = "53ad5054";
    const API_KEY = "4a64194066e8fd3e25092ba17e0bb02e";
    const GROQ_API_KEY = "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";

    async function processImage() {
      const file = document.getElementById("imageInput").files[0];
      if (!file) return alert("Please upload an image.");
      document.getElementById("preview").src = URL.createObjectURL(file);
      document.getElementById("preview").style.display = 'block';
      document.getElementById("loading1").innerText = "Extracting text...";
      const result = await Tesseract.recognize(file, 'eng');
      const rawText = result.data.text.trim();
      document.getElementById("ocrText").innerText = rawText;
      document.getElementById("loading1").innerText = "Cleaning ingredients using AI...";
      const cleanedIngredients = await cleanIngredientsWithAI(rawText);
      const ingredientsArray = cleanedIngredients.split(/,\s*/);
      document.getElementById("loading1").innerText = "Analyzing nutrition...";
      const nutritionData = await fetchNutrition(cleanedIngredients);
      document.getElementById("nutritionText").innerText = nutritionData.output;
      const aiResponse = await askGroqAI(ingredientsArray);
      document.getElementById("aiExplanation").innerText = aiResponse;
      document.getElementById("loading1").innerText = "";
    }

    async function analyzeUserFood() {
      const query = document.getElementById("userText").value.trim();
      if (!query) return;
      document.getElementById("loading2").innerText = "Analyzing...";
      const nutritionData = await fetchNutrition(query);
      document.getElementById("userNutrition").innerText = nutritionData.output;
      const aiResponse = await askGroqAI(nutritionData.ingredients);
      document.getElementById("userAiExplanation").innerText = aiResponse;
      document.getElementById("loading2").innerText = "";
    }

    async function fetchNutrition(query) {
      const res = await fetch("https://trackapi.nutritionix.com/v2/natural/nutrients", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-app-id": APP_ID,
          "x-app-key": API_KEY
        },
        body: JSON.stringify({ query })
      });
      const data = await res.json();
      let ingredients = [];
      let output = "";
      data.foods?.forEach(f => {
        ingredients.push(f.food_name);
        output += `\u{1F35D} ${f.food_name}\nCalories: ${f.nf_calories} kcal\nFat: ${f.nf_total_fat}g\nCarbs: ${f.nf_total_carbohydrate}g\nProtein: ${f.nf_protein}g\n\n`;
      });
      return { ingredients, output };
    }

    async function cleanIngredientsWithAI(rawText) {
      const prompt = `This text was extracted from a food label using OCR and may contain typos. Please identify and return only the cleaned list of ingredients, separated by commas.\n\nOCR Text:\n${rawText}`;
      const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${GROQ_API_KEY}`
        },
        body: JSON.stringify({
          model: "meta-llama/llama-4-scout-17b-16e-instruct",
          messages: [
            { role: "user", content: prompt }
          ]
        })
      });
      const data = await res.json();
      return data.choices?.[0]?.message?.content || rawText;
    }

    async function askGroqAI(ingredients) {
      const prompt = `For each of the following ingredients, answer in simple terms:\n1. What is it?\n2. Who should or shouldn't eat it?\n3. Any health warnings or benefits.\n\nIngredients:\n${ingredients.join("\n")}`;
      const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${GROQ_API_KEY}`
        },
        body: JSON.stringify({
          model: "meta-llama/llama-4-scout-17b-16e-instruct",
          messages: [
            { role: "user", content: prompt }
          ]
        })
      });
      const json = await res.json();
      return json.choices?.[0]?.message?.content || "AI response failed.";
    }
  </script>
</body>
</html>
