<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriScan AI</title>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
    <style>
        /* Custom styles for the prose-like content generated by AI */
        body {
            font-family: 'Inter', sans-serif;
        }
        .prose :where(h1, h2, h3, h4, h5, h6) {
            color: #facc15; /* yellow-400 */
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        .prose :where(p, ul, ol, pre) {
            color: #d1d5db; /* gray-300 */
            line-height: 1.75;
        }
        .prose :where(li) {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        .prose :where(strong) {
            color: #facc15;
        }
        .prose details summary {
            color: #fcd34d; /* yellow-300 */
        }
        .prose pre {
            background-color: #1f2937; /* gray-800 */
            border-radius: 0.5rem;
            padding: 1rem;
            overflow-x: auto;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center py-8 px-4">

    <!-- Message Box -->
    <div id="messageBox" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg flex items-center space-x-3 text-white hidden">
        <span id="messageIcon"></span>
        <span id="messageText"></span>
        <button onclick="hideMessage()" class="ml-4 text-white hover:text-gray-200">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
        </button>
    </div>

    <!-- Header -->
    <header class="w-full max-w-4xl text-center mb-12">
        <h1 class="text-5xl font-extrabold text-yellow-400 mb-4 tracking-tight">
            NutriScan AI
        </h1>
        <p class="text-gray-300 text-lg">
            Your personal AI-powered food analyzer. Scan labels, track meals, and make smarter dietary choices.
        </p>
    </header>

    <!-- Main Content Area -->
    <div class="w-full max-w-6xl grid grid-cols-1 md:grid-cols-2 gap-8">

        <!-- Image Analyzer Section -->
        <div class="bg-gray-800 p-8 rounded-2xl shadow-xl flex flex-col items-center">
            <h2 class="text-3xl font-bold text-indigo-400 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-camera mr-3"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3.5L14.5 4z"/><circle cx="12" cy="13" r="3"/></svg>
                Analyze Food Label
            </h2>
            <input
                type="file"
                accept="image/*"
                id="imageInput"
                onchange="handleImageChange(event)"
                class="w-full p-3 mb-4 text-gray-300 bg-gray-700 border border-gray-600 rounded-xl focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700"
            />
            <button
                onclick="processImage()"
                id="processImageBtn"
                class="w-full bg-gradient-to-r from-indigo-600 to-purple-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:from-indigo-700 hover:to-purple-800 transition duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
            >
                <svg id="imageAnalyzerSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.062 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="imageAnalyzerBtnText">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search mr-2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    Extract & Analyze
                </span>
            </button>

            <img id="imagePreview" alt="Label Preview" class="mt-6 rounded-xl shadow-md border border-gray-700 hidden" />

            <details id="ocrTextDetails" class="mt-6 p-4 bg-gray-700 rounded-lg shadow-inner w-full hidden">
                <summary class="font-semibold text-yellow-300 cursor-pointer flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info mr-2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                    Raw OCR Text
                </summary>
                <pre id="ocrTextOutput" class="mt-2 text-gray-300 text-sm whitespace-pre-wrap break-words"></pre>
            </details>

            <div id="nutritionSummaryOutput" class="mt-6 p-6 bg-gray-700 rounded-lg shadow-inner w-full hidden">
                <h3 class="text-xl font-semibold text-green-400 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart mr-2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                    Nutrition Summary
                </h3>
                <p class="text-gray-200 mb-2">Total Calories: <span class="font-bold text-yellow-300" id="totalCalories">0 kcal</span></p>
                <p class="text-gray-200 mb-2">Total Fat: <span class="font-bold text-yellow-300" id="totalFat">0g</span></p>
                <p class="text-gray-200 mb-2">Total Carbs: <span class="font-bold text-yellow-300" id="totalCarbs">0g</span></p>
                <p class="text-gray-200 mb-4">Total Protein: <span class="font-bold text-yellow-300" id="totalProtein">0g</span></p>
                <pre id="detailedNutritionOutput" class="text-gray-300 text-sm whitespace-pre-wrap break-words"></pre>
            </div>

            <div id="aiExplanationOutput" class="w-full"></div>

            <label for="filters" class="block mt-6 mb-2 font-medium text-gray-300 w-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-circle inline-block mr-2 text-red-400"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>
                Flag ingredients you avoid (comma-separated)
            </label>
            <input
                type="text"
                id="filters"
                placeholder="e.g. gluten, soy, sugar, dairy"
                oninput="updateFlaggedIngredients()"
                class="w-full p-3 text-gray-300 bg-gray-700 border border-gray-600 rounded-xl focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
            />
            <div id="flaggedIngredientsOutput" class="w-full"></div>
        </div>

        <!-- Personal Diet Analyzer Section -->
        <div class="bg-gray-800 p-8 rounded-2xl shadow-xl flex flex-col items-center">
            <h2 class="text-3xl font-bold text-indigo-400 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user mr-3"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                Analyze Your Meal
            </h2>
            <label for="userText" class="block mb-2 font-medium text-gray-300 w-full">
                Describe Your Meal (e.g., 1 boiled egg, 1 toast, 1 cup coffee)
            </label>
            <textarea
                id="userText"
                placeholder="E.g., 1 boiled egg, 1 toast, 1 cup coffee"
                rows="4"
                class="w-full p-3 mb-4 text-gray-300 bg-gray-700 border border-gray-600 rounded-xl focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
            ></textarea>

            <label for="condition" class="block mb-2 font-medium text-gray-300 w-full">
                Select Your Health Condition
            </label>
            <select
                id="condition"
                class="w-full p-3 mb-6 text-gray-300 bg-gray-700 border border-gray-600 rounded-xl focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
            >
                <option value="none">None</option>
                <option value="diabetes">Diabetes</option>
                <option value="hypertension">High Blood Pressure</option>
                <option value="celiac">Celiac/Gluten Intolerant</option>
                <option value="high_cholesterol">High Cholesterol</option>
                <option value="kidney_disease">Kidney Disease</option>
                <option value="heart_disease">Heart Disease</option>
                <option value="allergies">Specific Allergies (e.g., nuts, shellfish)</option>
            </select>

            <button
                onclick="analyzeUserFood()"
                id="analyzeUserFoodBtn"
                class="w-full bg-gradient-to-r from-indigo-600 to-purple-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:from-indigo-700 hover:to-purple-800 transition duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
            >
                <svg id="personalAnalyzerSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.062 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="personalAnalyzerBtnText">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search mr-2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    Analyze Meal
                </span>
            </button>

            <div id="userNutritionSummaryOutput" class="mt-6 p-6 bg-gray-700 rounded-lg shadow-inner w-full hidden">
                <h3 class="text-xl font-semibold text-green-400 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart mr-2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                    Your Meal Nutrition Summary
                </h3>
                <p class="text-gray-200 mb-2">Total Calories: <span class="font-bold text-yellow-300" id="userTotalCalories">0 kcal</span></p>
                <p class="text-gray-200 mb-2">Total Fat: <span class="font-bold text-yellow-300" id="userTotalFat">0g</span></p>
                <p class="text-gray-200 mb-2">Total Carbs: <span class="font-bold text-yellow-300" id="userTotalCarbs">0g</span></p>
                <p class="text-gray-200 mb-4">Total Protein: <span class="font-bold text-yellow-300" id="userTotalProtein">0g</span></p>
                <pre id="userDetailedNutritionOutput" class="text-gray-300 text-sm whitespace-pre-wrap break-words"></pre>
            </div>

            <div id="userAiExplanationOutput" class="w-full"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="w-full max-w-4xl text-center mt-16 text-gray-500 text-sm">
        <p>&copy; <span id="currentYear"></span> NutriScan AI. All rights reserved.</p>
        <p>Powered by Tesseract.js, Nutritionix, and Groq AI.</p>
    </footer>

    <script>
        // Set current year in footer
        document.getElementById('currentYear').innerText = new Date().getFullYear();

        // Nutritionix API keys
        const APP_ID = "53ad5054";
        const API_KEY = "4a64194066e8fd3e25092ba17e0bb02e";
        // Groq API key (replace with your actual key if different)
        const GROQ_API_KEY = "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";

        // Global variables to store data for dynamic updates
        let currentNutritionData = null; // Stores data from image analysis
        let currentUserNutritionData = null; // Stores data from personal meal analysis

        // --- Message Box Functions ---
        function showMessage(msg, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const messageIcon = document.getElementById('messageIcon');

            messageText.innerText = msg;
            messageBox.className = 'fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg flex items-center space-x-3 text-white';

            let bgColorClass = 'bg-blue-500';
            let iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>`;

            switch (type) {
                case 'success':
                    bgColorClass = 'bg-green-500';
                    iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>`;
                    break;
                case 'error':
                    bgColorClass = 'bg-red-500';
                    iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>`;
                    break;
                case 'warning':
                    bgColorClass = 'bg-yellow-500';
                    iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-circle"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>`;
                    break;
            }
            messageBox.classList.add(bgColorClass);
            messageIcon.innerHTML = iconSvg;
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                hideMessage();
            }, 5000);
        }

        function hideMessage() {
            document.getElementById('messageBox').classList.add('hidden');
            document.getElementById('messageBox').className = 'fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg flex items-center space-x-3 text-white hidden'; // Reset classes
        }

        // --- Image Analyzer Functions ---
        function handleImageChange(event) {
            const file = event.target.files[0];
            const imagePreview = document.getElementById('imagePreview');
            if (file) {
                imagePreview.src = URL.createObjectURL(file);
                imagePreview.classList.remove('hidden');
                // Clear previous results
                document.getElementById('ocrTextOutput').innerText = '';
                document.getElementById('ocrTextDetails').classList.add('hidden');
                document.getElementById('nutritionSummaryOutput').classList.add('hidden');
                document.getElementById('aiExplanationOutput').innerHTML = '';
                document.getElementById('flaggedIngredientsOutput').innerHTML = '';
                currentNutritionData = null; // Reset stored data
            } else {
                imagePreview.classList.add('hidden');
            }
        }

        async function processImage() {
            const fileInput = document.getElementById('imageInput');
            if (!fileInput.files[0]) {
                showMessage("Please upload an image of a food label.", "warning");
                return;
            }

            setLoadingState('imageAnalyzer', true, "Extracting text from image...");
            document.getElementById('ocrTextOutput').innerText = '';
            document.getElementById('ocrTextDetails').classList.add('hidden');
            document.getElementById('nutritionSummaryOutput').classList.add('hidden');
            document.getElementById('aiExplanationOutput').innerHTML = '';
            document.getElementById('flaggedIngredientsOutput').innerHTML = '';
            currentNutritionData = null;

            try {
                const result = await Tesseract.recognize(fileInput.files[0], 'eng');
                const rawText = result.data.text.trim();
                document.getElementById('ocrTextOutput').innerText = rawText;
                document.getElementById('ocrTextDetails').classList.remove('hidden');

                setLoadingState('imageAnalyzer', true, "Cleaning ingredients using AI...");
                const cleanedIngredients = await cleanIngredientsWithAI(rawText);

                setLoadingState('imageAnalyzer', true, "Analyzing nutrition data...");
                const nutritionData = await fetchNutrition(cleanedIngredients);
                currentNutritionData = nutritionData; // Store for flagging

                if (nutritionData.output) {
                    document.getElementById('totalCalories').innerText = `${nutritionData.totalCalories} kcal`;
                    document.getElementById('totalFat').innerText = `${nutritionData.totalFat}g`;
                    document.getElementById('totalCarbs').innerText = `${nutritionData.totalCarbs}g`;
                    document.getElementById('totalProtein').innerText = `${nutritionData.totalProtein}g`;
                    document.getElementById('detailedNutritionOutput').innerText = nutritionData.output;
                    document.getElementById('nutritionSummaryOutput').classList.remove('hidden');
                }

                const ingredientsArray = nutritionData.ingredients.map(item => item.food_name);
                updateFlaggedIngredients(ingredientsArray); // Initial flag update

                setLoadingState('imageAnalyzer', true, "Generating AI insights...");
                const aiResponse = await askGroqAI(ingredientsArray);
                document.getElementById('aiExplanationOutput').innerHTML = aiResponse;

                showMessage("Food label analyzed successfully!", "success");
            } catch (error) {
                console.error("Error processing image:", error);
                showMessage("Failed to analyze image. Please try again.", "error");
            } finally {
                setLoadingState('imageAnalyzer', false);
            }
        }

        async function cleanIngredientsWithAI(rawText) {
            const prompt = `The following text was extracted from a food label and may contain typos, irrelevant information, or be poorly formatted. Your task is to identify and return ONLY a clean, comma-separated list of ingredients. Do not include nutritional facts, serving sizes, or any other information. If no clear ingredients list is present, return "No ingredients found."

            Example:
            Input: "Nutrition Facts: Serving Size 1 cup. Ingredients: Enriched Flour, Sugar, Palm Oil, Salt, Baking Soda. Per serving: Calories 100."
            Output: "Enriched Flour, Sugar, Palm Oil, Salt, Baking Soda"

            Input: "Best by 2025. Made in USA. Ingredients: Water, High Fructose Corn Syrup, Natural Flavors, Citric Acid."
            Output: "Water, High Fructose Corn Syrup, Natural Flavors, Citric Acid"

            Input: "OCR Text: ${rawText}`;

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "llama3-8b-8192",
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.1
                    })
                });
                const data = await res.json();
                return data.choices?.[0]?.message?.content || "No ingredients found.";
            } catch (error) {
                console.error("Error cleaning ingredients with AI:", error);
                showMessage("AI cleaning failed. Using raw text for analysis.", "warning");
                return rawText;
            }
        }

        function updateFlaggedIngredients(ingredients = null) {
            const flaggedInput = document.getElementById("filters").value.toLowerCase().split(/,\s*/).filter(Boolean);
            const flaggedOutputDiv = document.getElementById("flaggedIngredientsOutput");

            // Use the ingredients from currentNutritionData if not explicitly provided
            const ingredientsToFlag = ingredients || (currentNutritionData ? currentNutritionData.ingredients.map(item => item.food_name) : []);

            if (flaggedInput.length === 0 || ingredientsToFlag.length === 0) {
                flaggedOutputDiv.innerHTML = "";
                return;
            }

            const matched = ingredientsToFlag.filter(ing => flaggedInput.some(flag => ing.toLowerCase().includes(flag)));

            if (matched.length) {
                flaggedOutputDiv.innerHTML = `
                    <div class='mt-4 p-4 bg-red-800 bg-opacity-30 rounded-lg border border-red-700'>
                        <p class='font-semibold text-red-400 mb-2 flex items-center'>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-circle mr-2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>
                            Avoided Ingredients Found:
                        </p>
                        <ul class='list-disc list-inside text-red-200'>
                            ${matched.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>`;
            } else {
                flaggedOutputDiv.innerHTML = "";
            }
        }


        // --- Personal Diet Analyzer Functions ---
        async function analyzeUserFood() {
            const userText = document.getElementById('userText').value.trim();
            const healthCondition = document.getElementById('condition').value;

            if (!userText) {
                showMessage("Please describe your meal to analyze.", "warning");
                return;
            }

            setLoadingState('personalAnalyzer', true, "Analyzing your meal...");
            document.getElementById('userNutritionSummaryOutput').classList.add('hidden');
            document.getElementById('userAiExplanationOutput').innerHTML = '';
            currentUserNutritionData = null;

            try {
                const nutritionData = await fetchNutrition(userText);
                currentUserNutritionData = nutritionData; // Store for potential future use

                if (nutritionData.output) {
                    document.getElementById('userTotalCalories').innerText = `${nutritionData.totalCalories} kcal`;
                    document.getElementById('userTotalFat').innerText = `${nutritionData.totalFat}g`;
                    document.getElementById('userTotalCarbs').innerText = `${nutritionData.totalCarbs}g`;
                    document.getElementById('userTotalProtein').innerText = `${nutritionData.totalProtein}g`;
                    document.getElementById('userDetailedNutritionOutput').innerText = nutritionData.output;
                    document.getElementById('userNutritionSummaryOutput').classList.remove('hidden');
                }

                setLoadingState('personalAnalyzer', true, "Generating personalized AI insights...");
                const ingredientsArray = nutritionData.ingredients.map(item => item.food_name);
                const aiResponse = await askGroqAI(ingredientsArray, healthCondition);
                document.getElementById('userAiExplanationOutput').innerHTML = aiResponse;

                showMessage("Meal analyzed successfully!", "success");
            } catch (error) {
                console.error("Error analyzing user food:", error);
                showMessage("Failed to analyze your meal. Please try again.", "error");
            } finally {
                setLoadingState('personalAnalyzer', false);
            }
        }

        // --- Common Functions (used by both analyzers) ---
        async function fetchNutrition(query) {
            try {
                const res = await fetch("https://trackapi.nutritionix.com/v2/natural/nutrients", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-app-id": APP_ID,
                        "x-app-key": API_KEY
                    },
                    body: JSON.stringify({ query })
                });
                const data = await res.json();

                let totalCalories = 0;
                let totalFat = 0;
                let totalCarbs = 0;
                let totalProtein = 0;
                let ingredientsList = [];
                let outputText = "";

                if (data.foods && data.foods.length > 0) {
                    data.foods.forEach(f => {
                        ingredientsList.push(f);
                        totalCalories += f.nf_calories || 0;
                        totalFat += f.nf_total_fat || 0;
                        totalCarbs += f.nf_total_carbohydrate || 0;
                        totalProtein += f.nf_protein || 0;
                        outputText += `â€¢ ${f.food_name}: ${f.nf_calories?.toFixed(1) || 0} kcal, Fat: ${f.nf_total_fat?.toFixed(1) || 0}g, Carbs: ${f.nf_total_carbohydrate?.toFixed(1) || 0}g, Protein: ${f.nf_protein?.toFixed(1) || 0}g\n`;
                    });
                } else {
                    outputText = "No detailed nutrition data found for these items.";
                }

                return {
                    ingredients: ingredientsList,
                    output: outputText,
                    totalCalories: totalCalories.toFixed(1),
                    totalFat: totalFat.toFixed(1),
                    totalCarbs: totalCarbs.toFixed(1),
                    totalProtein: totalProtein.toFixed(1)
                };
            } catch (error) {
                console.error("Error fetching nutrition:", error);
                showMessage("Failed to fetch nutrition data. Please check the input.", "error");
                return { ingredients: [], output: "Error fetching nutrition data.", totalCalories: 0, totalFat: 0, totalCarbs: 0, totalProtein: 0 };
            }
        }

        async function askGroqAI(ingredients, condition = "none") {
            if (ingredients.length === 0 || ingredients[0] === "No ingredients found.") {
                return `<p class='text-gray-400'>No specific ingredients to analyze.</p>`;
            }

            const prompt = `As a highly knowledgeable food and nutrition expert, analyze the following ingredients. For each ingredient, provide:
            1.  **What it is:** A brief, clear description.
            2.  **Who should/shouldn't consume it:** Specific groups or individuals who should be cautious or avoid it, and those who might benefit.
            3.  **Health implications:** Key benefits, potential risks, or warnings.
            4.  **Consider the user's health condition:** The user has indicated their condition is "${condition}". Tailor your advice accordingly.

            Format your response clearly with headings for each ingredient. Conclude with an overall summary of the meal's suitability for the user's condition if a condition is specified.

            Ingredients:
            ${ingredients.join("\n")}`;

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "llama3-8b-8192",
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.7
                    })
                });
                const json = await res.json();
                const rawText = json.choices?.[0]?.message?.content || "AI analysis is currently unavailable.";
                return `<details class="mt-4 p-4 bg-gray-800 rounded-lg shadow-inner">
                            <summary class="font-semibold text-yellow-300 cursor-pointer flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search mr-2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                                Detailed Analysis
                            </summary>
                            <div class="prose prose-invert text-gray-300 mt-4 max-w-none">
                                ${rawText.replace(/\n/g, '<br/>')}
                            </div>
                        </details>`;
            } catch (error) {
                console.error("Error asking Groq AI:", error);
                showMessage("AI analysis failed to load.", "error");
                return `<p class='text-red-400'>Failed to load AI analysis. Please try again later.</p>`;
            }
        }

        // --- Loading State Management ---
        function setLoadingState(analyzerType, isLoading, message = '') {
            let spinnerId, btnTextId, btnId;
            if (analyzerType === 'imageAnalyzer') {
                spinnerId = 'imageAnalyzerSpinner';
                btnTextId = 'imageAnalyzerBtnText';
                btnId = 'processImageBtn';
            } else if (analyzerType === 'personalAnalyzer') {
                spinnerId = 'personalAnalyzerSpinner';
                btnTextId = 'personalAnalyzerBtnText';
                btnId = 'analyzeUserFoodBtn';
            }

            const spinner = document.getElementById(spinnerId);
            const btnText = document.getElementById(btnTextId);
            const button = document.getElementById(btnId);

            if (isLoading) {
                spinner.classList.remove('hidden');
                btnText.innerHTML = message; // Update button text with loading message
                button.disabled = true;
            } else {
                spinner.classList.add('hidden');
                button.disabled = false;
                // Reset button text to original icon + text
                if (analyzerType === 'imageAnalyzer') {
                    btnText.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search mr-2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg> Extract & Analyze`;
                } else if (analyzerType === 'personalAnalyzer') {
                    btnText.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search mr-2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg> Analyze Meal`;
                }
            }
        }
    </script>
</body>
</html>
