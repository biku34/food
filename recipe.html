<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriChef AI - Personalized Recipes</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the prose-like content generated by AI */
        body {
            font-family: 'Inter', sans-serif;
        }
        .prose :where(h1, h2, h3, h4, h5, h6) {
            color: #facc15; /* yellow-400 */
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        .prose :where(p, ul, ol, pre, div) {
            color: #d1d5db; /* gray-300 */
            line-height: 1.75;
        }
        .prose :where(li) {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        .prose :where(strong) {
            color: #facc15;
        }
        .prose details summary {
            color: #fcd34d; /* yellow-300 */
        }
        .prose pre {
            background-color: #1f2937; /* gray-800 */
            border-radius: 0.5rem;
            padding: 1rem;
            overflow-x: auto;
        }
        /* Custom scrollbar for chat history */
        #chatHistory::-webkit-scrollbar {
            width: 8px;
        }
        #chatHistory::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 10px;
        }
        #chatHistory::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 10px;
        }
        #chatHistory::-webkit-scrollbar-thumb:hover {
            background: #4338ca;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center py-8 px-4">

    <div id="messageBox" role="alert" aria-live="polite" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg flex items-center space-x-3 text-white hidden">
        <span id="messageIcon" aria-hidden="true"></span>
        <span id="messageText"></span>
        <button onclick="hideMessage()" class="ml-4 text-white hover:text-gray-200" aria-label="Close message">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
        </button>
    </div>

    <header class="w-full max-w-4xl text-center mb-12">
        <h1 class="text-5xl font-extrabold text-yellow-400 mb-4 tracking-tight">
            NutriChef AI
        </h1>
        <p class="text-gray-300 text-lg">
            Your personal AI chef. Get recipes tailored to your mood, health goals, and pantry!
        </p>
    </header>

    <div class="w-full max-w-3xl bg-gray-800 p-8 rounded-2xl shadow-xl flex flex-col h-[95vh] md:h-[90vh] lg:h-[85vh]">
        <h2 class="text-3xl font-bold text-indigo-400 mb-6 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square mr-3"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            Recipe Chatbot
        </h2>

        <div id="chatHistory" class="flex-1 overflow-y-auto p-4 bg-gray-700 rounded-lg mb-6 space-y-4">
            <div class="flex justify-start">
                <div class="bg-indigo-600 text-white p-3 rounded-xl rounded-bl-none max-w-[80%] shadow-md">
                    Hello! I'm NutriChef AI. Tell me what kind of recipe you're looking for. You can also specify your mood, health conditions, or dietary preferences using the options below.
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
                <label for="mood" class="block text-sm font-medium text-gray-300 mb-1">Mood:</label>
                <select id="mood" class="w-full p-2 text-gray-300 bg-gray-700 border border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                    <option value="none">Any Mood</option>
                    <option value="comforting">Comforting</option>
                    <option value="energizing">Energizing</option>
                    <option value="light_refreshing">Light & Refreshing</option>
                    <option value="indulgent">Indulgent</option>
                    <option value="quick_easy">Quick & Easy</option>
                    <option value="celebratory">Celebratory</option>
                </select>
            </div>
            <div>
                <label for="healthCondition" class="block text-sm font-medium text-gray-300 mb-1">Health:</label>
                <select id="healthCondition" class="w-full p-2 text-gray-300 bg-gray-700 border border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                    <option value="none">No Specific Condition</option>
                    <option value="diabetes">Diabetes-Friendly</option>
                    <option value="hypertension">Low Sodium</option>
                    <option value="celiac">Gluten-Free</option>
                    <option value="high_cholesterol">Low Cholesterol</option>
                    <option value="kidney_disease">Kidney-Friendly</option>
                    <option value="heart_disease">Heart-Healthy</option>
                </select>
            </div>
            <div>
                <label for="dietaryPreference" class="block text-sm font-medium text-gray-300 mb-1">Dietary:</label>
                <select id="dietaryPreference" class="w-full p-2 text-gray-300 bg-gray-700 border border-gray-600 rounded-lg focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                    <option value="none">Any Diet</option>
                    <option value="vegan">Vegan</option>
                    <option value="vegetarian">Vegetarian</option>
                    <option value="keto">Keto</option>
                    <option value="paleo">Paleo</option>
                    <option value="pescatarian">Pescatarian</option>
                    <option value="dairy_free">Dairy-Free</option>
                    <option value="nut_free">Nut-Free</option>
                </select>
            </div>
        </div>

        <div class="flex space-x-3">
            <input
                type="text"
                id="userInput"
                placeholder="E.g., 'a quick chicken dinner' or 'vegetarian pasta'"
                class="flex-1 p-3 text-gray-300 bg-gray-700 border border-gray-600 rounded-xl focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"
                onkeypress="handleKeyPress(event)"
                aria-label="Type your recipe request"
            />
            <button
                onclick="generateRecipe()"
                id="generateRecipeBtn"
                class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:from-indigo-700 hover:to-purple-800 transition duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                aria-busy="false" aria-live="polite"
            >
                <svg id="recipeSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.062 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="recipeBtnText">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chef-hat mr-2"><path d="M12 2a6 6 0 0 0-6 6v3.5a4 4 0 0 1-.5 7.5L2 22"/><path d="M12 2a6 6 0 0 1 6 6v3.5a4 4 0 0 0 .5 7.5L22 22"/><path d="M5 20s-2 0-2 2"/><path d="M19 20s2 0 2 2"/><path d="M15 17a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/></svg>
                    Generate Recipe
                </span>
            </button>
            <button
                onclick="clearChat()"
                class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 flex items-center justify-center"
                aria-label="Clear chat history"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 mr-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                Clear
            </button>
        </div>
    </div>

    <footer class="w-full max-w-4xl text-center mt-16 text-gray-500 text-sm">
        <p>&copy; <span id="currentYear"></span> NutriChef AI. All rights reserved.</p>
        <p>Powered by Groq AI.</p>
    </footer>

    <script>
        // Set current year in footer
        document.getElementById('currentYear').innerText = new Date().getFullYear();

        // Groq API key
        const GROQ_API_KEY = "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"; // Replace with your actual key if different

        // --- Message Box Functions (reused from NutriScan AI) ---
        /**
         * Displays a custom message box with a specified message and type.
         * @param {string} msg - The message to display.
         * @param {'info'|'success'|'error'|'warning'} type - The type of message (influences color and icon).
         */
        function showMessage(msg, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const messageIcon = document.getElementById('messageIcon');

            messageText.innerText = msg;
            messageBox.className = 'fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg flex items-center space-x-3 text-white';

            let bgColorClass = 'bg-blue-500';
            let iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>`;

            switch (type) {
                case 'success':
                    bgColorClass = 'bg-green-500';
                    iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>`;
                    break;
                case 'error':
                    bgColorClass = 'bg-red-500';
                    iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>`;
                    break;
                case 'warning':
                    bgColorClass = 'bg-yellow-500';
                    iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-circle"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>`;
                    break;
            }
            messageBox.classList.add(bgColorClass);
            messageIcon.innerHTML = iconSvg;
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                hideMessage();
            }, 5000);
        }

        /**
         * Hides the custom message box.
         */
        function hideMessage() {
            const messageBox = document.getElementById('messageBox');
            messageBox.classList.add('hidden');
            messageBox.className = 'fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg flex items-center space-x-3 text-white hidden';
        }

        // --- Chatbot Core Functions ---
        /**
         * Appends a message to the chat history.
         * @param {string} sender - 'user' or 'bot'.
         * @param {string} messageHtml - The message content, can be plain text or HTML.
         */
        function appendMessage(sender, messageHtml) {
            const chatHistory = document.getElementById('chatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `p-3 rounded-xl max-w-[80%] shadow-md ${
                sender === 'user'
                    ? 'bg-purple-600 text-white rounded-br-none'
                    : 'bg-indigo-600 text-white rounded-bl-none'
            } prose prose-invert`; // Apply prose for AI generated HTML

            bubbleDiv.innerHTML = messageHtml;
            messageDiv.appendChild(bubbleDiv);
            chatHistory.appendChild(messageDiv);

            // Scroll to the bottom of the chat history
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        /**
         * Handles the Enter key press in the user input field.
         * @param {KeyboardEvent} event - The keyboard event.
         */
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                generateRecipe();
            }
        }

        /**
         * Generates a recipe based on user input and selected factors.
         */
        async function generateRecipe() {
            const userInput = document.getElementById('userInput').value.trim();
            const mood = document.getElementById('mood').value;
            const healthCondition = document.getElementById('healthCondition').value;
            const dietaryPreference = document.getElementById('dietaryPreference').value;

            if (!userInput && mood === 'none' && healthCondition === 'none' && dietaryPreference === 'none') {
                showMessage("Please tell me what kind of recipe you're looking for, or select some preferences.", "warning");
                return;
            }

            // Display user's request in chat
            let userRequestText = userInput;
            if (mood !== 'none') userRequestText += ` (Mood: ${mood.replace(/_/g, ' ')})`;
            if (healthCondition !== 'none') userRequestText += ` (Health: ${healthCondition.replace(/_/g, ' ')})`;
            if (dietaryPreference !== 'none') userRequestText += ` (Diet: ${dietaryPreference.replace(/_/g, ' ')})`;

            appendMessage('user', userRequestText);
            document.getElementById('userInput').value = ''; // Clear input

            setLoadingState(true, "Crafting your personalized recipe...");

            try {
                const recipeHtml = await fetchRecipeFromAI(userInput, mood, healthCondition, dietaryPreference);
                appendMessage('bot', recipeHtml);
                showMessage("Recipe generated successfully!", "success");
            } catch (error) {
                console.error("Error generating recipe:", error);
                appendMessage('bot', "<p class='text-red-300'>Oops! I couldn't generate a recipe right now. Please try again or refine your request.</p>");
                showMessage("Failed to generate recipe.", "error");
            } finally {
                setLoadingState(false);
            }
        }

        /**
         * Fetches a personalized recipe from Groq AI.
         * @param {string} userInput - The user's free-form text input.
         * @param {string} mood - Selected mood.
         * @param {string} healthCondition - Selected health condition.
         * @param {string} dietaryPreference - Selected dietary preference.
         * @returns {Promise<string>} A promise resolving to an HTML string of the recipe.
         */
        async function fetchRecipeFromAI(userInput, mood, healthCondition, dietaryPreference) {
            let prompt = `Generate a detailed recipe based on the following criteria.
            Format the response strictly as HTML. Use the following structure:
            - <h3> for the Recipe Name.
            - <p> for a brief description, prep time, cook time, and servings.
            - <h4> for "Ingredients" and "Instructions".
            - <ul> and <li> for ingredients list.
            - <ol> and <li> for instructions.
            - Optional: Add a <h4> for "Chef's Notes" or "Nutritional Considerations" at the end, followed by <p> or <ul><li> for details.

            Criteria:
            - User Request: "${userInput || 'Any delicious meal'}"
            - Mood: "${mood !== 'none' ? mood.replace(/_/g, ' ') : 'Any'}"
            - Health Condition: "${healthCondition !== 'none' ? healthCondition.replace(/_/g, ' ') : 'None'}"
            - Dietary Preference: "${dietaryPreference !== 'none' ? dietaryPreference.replace(/_/g, ' ') : 'None'}"

            Ensure the recipe is practical and clearly written. If any criterion cannot be met, provide a suitable alternative or explanation within the recipe notes.`;

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "llama3-8b-8192", // Using a general model for creative text generation
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.8 // Higher temperature for more creative recipes
                    })
                });
                const json = await res.json();
                const rawText = json.choices?.[0]?.message?.content || "<p>I couldn't generate a recipe. Please try a different request.</p>";
                return rawText; // AI is instructed to return HTML directly
            } catch (error) {
                console.error("Error fetching recipe from AI:", error);
                throw error; // Re-throw to be caught by generateRecipe
            }
        }

        /**
         * Manages the loading state and messages for the recipe generation button.
         * @param {boolean} isLoading - True if loading, false otherwise.
         * @param {string} [message=''] - The loading message to display.
         */
        function setLoadingState(isLoading, message = '') {
            const spinner = document.getElementById('recipeSpinner');
            const btnText = document.getElementById('recipeBtnText');
            const button = document.getElementById('generateRecipeBtn');
            const userInput = document.getElementById('userInput');

            if (isLoading) {
                spinner.classList.remove('hidden');
                btnText.innerHTML = message;
                button.disabled = true;
                userInput.disabled = true;
                button.setAttribute('aria-busy', 'true');
            } else {
                spinner.classList.add('hidden');
                button.disabled = false;
                userInput.disabled = false;
                button.setAttribute('aria-busy', 'false');
                btnText.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chef-hat mr-2"><path d="M12 2a6 6 0 0 0-6 6v3.5a4 4 0 0 1-.5 7.5L2 22"/><path d="M12 2a6 6 0 0 1 6 6v3.5a4 4 0 0 0 .5 7.5L22 22"/><path d="M5 20s-2 0-2 2"/><path d="M19 20s2 0 2 2"/><path d="M15 17a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/></svg> Generate Recipe`;
            }
        }

        /**
         * Clears all messages from the chat history.
         */
        function clearChat() {
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.innerHTML = `
                <div class="flex justify-start">
                    <div class="bg-indigo-600 text-white p-3 rounded-xl rounded-bl-none max-w-[80%] shadow-md">
                        Hello! I'm NutriChef AI. Tell me what kind of recipe you're looking for. You can also specify your mood, health conditions, or dietary preferences using the options below.
                    </div>
                </div>
            `;
            document.getElementById('userInput').value = '';
            document.getElementById('mood').value = 'none';
            document.getElementById('healthCondition').value = 'none';
            document.getElementById('dietaryPreference').value = 'none';
            showMessage("Chat history cleared.", "info");
        }
    </script>
</body>
</html>
